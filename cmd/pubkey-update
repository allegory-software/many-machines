#!/bin/bash
# SSH | [KEYNAME] ["USER1 ..."] | update a ssh public key into machine(s)
. mmlib

KEYNAME=${1:-mm-$HOSTNAME}
USERS=$2
kf=var/ssh_key-$KEYNAME
[ -f $kf ] || {
	say "Key file $kf not found. Using ~/.ssh/id_rsa..."
	cp_file ~/.ssh/id_rsa $kf
	ssh-keygen -y -f $kf > $kf.pub
}
must catfile $kf.pub; PUBKEY="$R1"

_f() {
	local UP_PUBKEY=$(must ssh_script $1 "ssh_pubkey root $KEYNAME; true")
	if [[ $UP_PUBKEY == $PUBKEY ]]; then
		say "SSH public key '$KEYNAME' is there and it's the same."
	else
		ssh_script "ssh_pubkey_update" "$KEYNAME" "$PUBKEY" "$USERS"
		cp_file $kf  var/machines/$MACHINE/.ssh_key-$KEYNAME
	fi
}
each_machine _f
